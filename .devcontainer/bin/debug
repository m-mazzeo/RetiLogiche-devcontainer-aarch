#!/usr/bin/env bash

set -e

usage() {
    echo "Usage: $0 [-f] <executablePath>"
    exit 1
}

FORCE=0

while getopts ":f" opt; do
  case $opt in
    f)
      FORCE=1
      ;;
    \?)
      usage
      ;;
  esac
done

shift $((OPTIND -1))

if [ $# -lt 1 ]; then
    usage
fi

executablePath="$1"

if [ ! -f "$executablePath" ]; then
    echo "Path invalid"
    exit 1
fi

fileHeader=$(file "$executablePath")
if [[ "$fileHeader" != *"ELF 32-bit"* ]]; then
    if [ "$FORCE" -eq 0 ]; then
        echo "The file is not an executable"
        exit 1
    else
        echo "The file is not an executable"
    fi
fi

start_executable="qemu-i386-static -g 1337 $executablePath"
debug_executable="sleep 1 && gdb-multiarch -x /home/vscode/RETI/bin/files/gdb_startup \"$executablePath\""

# zellij --session deb --layout /home/vscode/RETI/bin/files/debug-layout.kdl

tmux new-session -d -s "deb" -n qemu \
	"$debug_executable; tmux wait-for qemu_done"

tmux split-window -h -t "deb" \
	"$start_executable; tmux wait-for -S qemu_done"

tmux attach-session -t "deb"\; select-pane -t 0
