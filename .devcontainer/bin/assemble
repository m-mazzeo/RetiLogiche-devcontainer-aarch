#!/usr/bin/env bash

set -e

usage() {
    echo "Usage: $0 [-f] <sourcePath>"
    exit 1
}

FORCE=0

while getopts ":f" opt; do
  case $opt in
    f)
      FORCE=1
      ;;
    \?)
      usage
      ;;
  esac
done

shift $((OPTIND -1))

if [ $# -lt 1 ]; then
    usage
fi

sourcePath="$1"

if [ ! -f "$sourcePath" ]; then
    echo "Path invalid"
    exit 1
fi

fileHeader=$(file "$sourcePath")
if [[ "$fileHeader" == *"ELF 32-bit"* ]]; then
    if [ "$FORCE" -eq 0 ]; then
        echo "The file is an executable"
        exit 1
    else
        echo "The file is an executable"
    fi
fi

dir=$(dirname "$sourcePath")
name=$(basename "$sourcePath")
name="${name%.*}"

BIN_DIR=/home/vscode/RETI/bin

# Cambio il percorso da "./files/utility.s" a /home/vscode/RETI/bin

cp $sourcePath /tmp/temp.s
sed -i 's|\.include "./files/utility\.s"|.include "/home/vscode/RETI/bin/files/utility.s"|' /tmp/temp.s

if ! i686-linux-gnu-gcc -m32 -no-pie -o "$dir/$name" '-Wa,-a' '-Wa,--defsym,LINUX=1' > "$dir/$name.lst" -g $BIN_DIR/files/main.c /tmp/temp.s; then
    echo "Assembler error"
fi
